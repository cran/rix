<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>z - Advanced topic: Running R or Shell Code in Nix from R</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">z - Advanced topic: Running R or Shell Code
in Nix from R</h1>



<div id="testing-code-in-evolving-software-dependency-environments-with-confidence" class="section level2">
<h2><strong>Testing code in evolving software dependency environments
with confidence</strong></h2>
<p>Adhering to sound versioning practices is crucial for ensuring the
reproducibility of software. Despite the expertise in software
engineering, the ever-growing complexity and continuous development of
new, potentially disruptive features present significant challenges in
maintaining code functionality over time. This pertains not only to
backward compatibility but also to future-proofing. When code handles
critical production loads and relies on numerous external software
libraries, it’s likely that these dependencies will evolve.
Infrastructure-as-code and other DevOps principles shine in addressing
these challenges. However, they may appear less approachable and more
labor-intensive to set up for the average R developer.</p>
<p>Are you ready to test your custom R functions and system commands in
a a different environment with isolated software builds that are both
pure at build and at runtime, without leaving the R console?</p>
<p>Let’s introduce <code>with_nix()</code>. <code>with_nix()</code> will
evaluate custom R code or shell commands with command line interfaces
provided by Nixpkgs in a Nix environment, and thereby bring the
read-eval-print-loop feeling. Not only can you evaluate custom R
functions or shell commands in Nix environments, but you can also bring
the results back to your current R session as R objects.</p>
</div>
<div id="two-operational-modes-of-computations-in-environments-system-to-nix-and-nix-to-nix" class="section level2">
<h2><strong>Two operational modes of computations in environments:
‘System-to-Nix’ and ‘Nix-to-Nix’</strong></h2>
<p>We aim to accommodate various use cases, considering a gradient of
declarativity in individual or sets of software environments based on
personal preferences. There are two main modes for defining and
comparing code running through R and system commands (command line
interfaces; CLIs)</p>
<ol style="list-style-type: decimal">
<li><strong>‘System-to-Nix’</strong> environments: We assume that you
launch an R session with an R version defined on your host operating
system, either from the terminal or an integrated development
environment like RStudio. You need to make sure that you actively
control and know where you installed R and R packages from, and at what
versions. You may have interactively tested that your custom function
pipeline worked for the current setup. Most importantly, you want to
check whether you get your computations running and achieve identical
results when going back to a Nix revision that represent either newer or
also older versions of R and package sources.</li>
<li><strong>‘Nix-to-Nix’</strong> environments: Your goals of testing
code are the same as in 1., but you want more fine-grained control in
the source environment where you launch <code>with_nix()</code> from,
too. You are probably on the way of getting a passionate Nix user.</li>
</ol>
</div>
<div id="case-study-1-evolution-of-base-r" class="section level2">
<h2><strong>Case study 1: Evolution of base R</strong></h2>
<p>Carefully curated software improves over time, so does R. We pick an
example from the R changelog, the following <a href="https://cran.r-project.org/doc/manuals/r-release/NEWS.html">literal
entry in R 4.2.0</a>:</p>
<ul>
<li>“<code>as.vector()</code> gains a <code>data.frame</code> method
which returns a simple named list, also clearing a long standing ‘FIXME’
to enable <code>as.vector(&lt;data.frame&gt;, mode =&quot;list&quot;)</code>. This
breaks code relying on <code>as.vector(&lt;data.frame&gt;)</code> to
return the unchanged data frame.”</li>
</ul>
<p>The goal is to illustrate this change in behavior from R versions
4.1.3 and before to R versions 4.2.0 and later.</p>
<div id="setting-up-the-r-software-environment-with-nix" class="section level3">
<h3>Setting up the (R) software environment with Nix</h3>
<p>First, we write a <code>default.nix</code> file containing Nix
expressions that pin R version 4.1.3 from Nixpkgs.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rix&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>path_env_1 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_env_1_R-4-1-3&quot;</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">rix</span>(</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="at">r_ver =</span> <span class="st">&quot;4.1.3&quot;</span>,</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_1</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>)</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#&gt; </span><span class="al">###</span><span class="co"> Bootstrapping isolated, project-specific, and runtime-pure R setup via Nix </span><span class="al">###</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">#&gt; ==&gt; Existing isolated nix-R project folder:</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#&gt;  /tmp/RtmppQ9Eym/Rbuild1d5c63c838c8/rix/vignettes/_env_1_R-4-1-3 </span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co">#&gt; * current R session running inside Nix environment and not from RStudio</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co">#&gt; * Keep existing `.Rprofile`. in `project_path`:</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="co">#&gt;  /tmp/RtmppQ9Eym/Rbuild1d5c63c838c8/rix/vignettes/_env_1_R-4-1-3/ </span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="co">#&gt; ==&gt; Also adjusting `PATH` via `Sys.setenv()`, so that system commands can invoke key Nix commands like `nix-build` in this RStudio session outside Nix</span></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a><span class="co">#&gt; </span><span class="al">###</span><span class="co"> Successfully generated `default.nix` and `.Rprofile` </span><span class="al">###</span></span></code></pre></div>
<p>The following expression is written to default.nix in the subfolder
<code>./_env_1_R-4-1-3/</code>.</p>
<pre><code>#&gt; # This file was generated by the {rix} R package v0.12.1 on 2024-09-24
#&gt; # with following call:
#&gt; # &gt;rix(r_ver = &quot;6e3a86f2f73a466656a401302d3ece26fba401d9&quot;,
#&gt; #  &gt; project_path = path_env_1,
#&gt; #  &gt; overwrite = TRUE)
#&gt; # It uses nixpkgs&#39; revision 6e3a86f2f73a466656a401302d3ece26fba401d9 for reproducibility purposes
#&gt; # which will install R version 4.1.3.
#&gt; # Report any issues to https://github.com/ropensci/rix
#&gt; let
#&gt;  pkgs = import (fetchTarball &quot;https://github.com/NixOS/nixpkgs/archive/6e3a86f2f73a466656a401302d3ece26fba401d9.tar.gz&quot;) {};
#&gt;      
#&gt;   system_packages = builtins.attrValues {
#&gt;     inherit (pkgs) 
#&gt;       glibcLocales
#&gt;       nix
#&gt;       R;
#&gt;   };
#&gt;   
#&gt; in
#&gt; 
#&gt; pkgs.mkShell {
#&gt;   LOCALE_ARCHIVE = if pkgs.system == &quot;x86_64-linux&quot; then &quot;${pkgs.glibcLocales}/lib/locale/locale-archive&quot; else &quot;&quot;;
#&gt;   LANG = &quot;en_US.UTF-8&quot;;
#&gt;    LC_ALL = &quot;en_US.UTF-8&quot;;
#&gt;    LC_TIME = &quot;en_US.UTF-8&quot;;
#&gt;    LC_MONETARY = &quot;en_US.UTF-8&quot;;
#&gt;    LC_PAPER = &quot;en_US.UTF-8&quot;;
#&gt;    LC_MEASUREMENT = &quot;en_US.UTF-8&quot;;
#&gt; 
#&gt;   buildInputs = [    system_packages   ];
#&gt;   
#&gt; }</code></pre>
<p>This also includes a custom <code>.Rprofile</code> file that ensure
that this subshell will not load any packages installed to the user’s
library of packages.</p>
</div>
<div id="defining-and-interactively-testing-custom-r-code-with-functions" class="section level3">
<h3>Defining and interactively testing custom R code with
function(s)</h3>
<p>We now have set up the configuration for R 4.1.3 set up in a
<code>default.nix</code> file in the folder
<code>./_env_1_R-4-1-3</code>. Since you are sure you are using an R
version higher 4.2.0 available on your system, you can check what that
<code>as.vector.data.frame()</code> S3 method returns a list.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">b =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">as.vector</span>(<span class="at">x =</span> df, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co">#&gt; $a</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co">#&gt; [1] 1 2 3</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; $b</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; [1] 4 5 6</span></span></code></pre></div>
<p>This is different for R versions 4.1.3 and below, where you should
get an identical data frame back.</p>
</div>
<div id="run-functioned-up-code-and-investigate-results-produced-in-pure-nix-rsoftware-environments" class="section level3">
<h3>Run functioned up code and investigate results produced in pure Nix
Rsoftware environments</h3>
<p>To formally validate in a ‘System-to-Nix’ approach that the object
returned from <code>as.vector.data.frame()</code> is before
<code>R</code> &lt; 4.2.0, we define a function that runs the
computation above.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>df_as_vector <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="at">x =</span> x, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>}</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>(out_system_1 <span class="ot">&lt;-</span> <span class="fu">df_as_vector</span>(<span class="at">x =</span> df))</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; $a</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; [1] 1 2 3</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; $b</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#&gt; [1] 4 5 6</span></span></code></pre></div>
<p>Then, we will evaluate this test code through a
<code>nix-shell</code> R session. This adds both build-time and run-time
purity with the declarative Nix software configuration we have made
earlier. <code>with_nix()</code> leverages the following principles
under the hood:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Computing on the Language:</strong> Manipulating language
objects using code.</p></li>
<li><p><strong>Static Code Analysis:</strong> Detecting global objects
and package environments in the function call stack of ‘expr’. This
involves utilizing essential functionality from the ‘codetools’ package,
which is recursively iterated.</p></li>
<li><p><strong>Serialization of Dependent R objects:</strong> Saving
them to disk and deserializing them back into the R session’s RAM via a
temporary folder. This process establishes isolation between two
distinct computational environments, accommodating both ‘System-to-Nix’
and ‘Nix-to-Nix’ computational modes. Simultaneously, it facilitates the
transfer of input arguments, dependencies across the call stack, and
outputs of <code>expr</code> between the Nix-R and the system’s R
sessions.</p></li>
</ol>
<p>This approach guarantees reproducible side effects and effectively
streams messages and errors into the R session. Thereby, the {sys}
package facilitates capturing standard outputs and errors as text output
messages. Please be aware that <code>with_nix()</code> will invoke
<code>nix-shell</code>, which will itself run <code>nix-build</code> in
case the Nix derivation (package) for R version 4.1.3 is not yet in your
Nix store. This will take a bit of time to get the cache. You will see
in your current R console the specific Nix paths that will be downloaded
and copied into your Nix store automatically.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># now run it in `nix-shell`; `with_nix()` takes care</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co"># of exporting global objects of `df_as_vector` recursively</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>out_nix_1 <span class="ot">&lt;-</span> <span class="fu">with_nix</span>(</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="at">expr =</span> <span class="cf">function</span>() <span class="fu">df_as_vector</span>(<span class="at">x =</span> df), <span class="co"># wrap to avoid evaluation</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>  <span class="at">program =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_1,</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>  <span class="at">message_type =</span> <span class="st">&quot;simple&quot;</span> <span class="co"># you can do `&quot;verbose&quot;`, too</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co"># compare results of custom codebase with indentical</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a><span class="co"># inputs and different software environments</span></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="fu">identical</span>(out_system_1, out_nix_1)</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="co"># should return `FALSE` if your system&#39;s R versions in</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co"># current interactive R session is R &gt;= 4.2.0</span></span></code></pre></div>
</div>
<div id="syntax-option-for-specifying-function-in-expr-argument-of-with_nix" class="section level3">
<h3>Syntax option for specifying function in <code>expr</code> argument
of <code>with_nix()</code></h3>
<p>In the previous code snippet we wrapped the top-level
<code>expr</code> function with <code>function()</code> or
<code>function(){}</code>. As an alternative, you can also provide
default arguments when assigning the function used as <code>expr</code>
input like this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>df_as_vector <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> df) {</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="at">x =</span> x, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>}</span></code></pre></div>
<p>Then, you just supply the name of the function to evaluate with
default arguments.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>out_nix_1_b <span class="ot">&lt;-</span> <span class="fu">with_nix</span>(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="at">expr =</span> df_as_vector, <span class="co"># provide name of function</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">program =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_1,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="at">message_type =</span> <span class="st">&quot;simple&quot;</span> <span class="co"># you can do `&quot;verbose&quot;`, too</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>)</span></code></pre></div>
<p>It yields the same results.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">Reduce</span>(<span class="at">f =</span> identical, <span class="fu">list</span>(out_nix_1, out_nix_1_b))</span></code></pre></div>
</div>
<div id="comparing-as.vector.data.frame-for-both-r-versions-4.1.3-and-4.2.0-from-nixpkgs" class="section level3">
<h3>Comparing <code>as.vector.data.frame()</code> for both R versions
4.1.3 and 4.2.0 from Nixpkgs</h3>
<p>Here follows an example a <code>Nix-to-Nix</code> solution, with two
subshells to track the evolution of base R in this specific case. We can
verify the breaking changes in case study 1 in more declarative manner
when we use both R 4.1.3 and R 4.2.0 from Nixpkgs. Since we already have
defined R 4.1.3 in the <em><code>env</code></em><code>_1_R-4-1-3</code>
subshell, we can use it as a source environment where with_nix() is
launched from. Accordingly, we define the R 4.2.0 environment in a
<em><code>env</code></em><code>_1_2_R-4-2-0</code>using Nix via
<code>rix::rix()</code>. The latter environment will be the target
environment where <code>df_as_vector()</code> will be evaluated in.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rix&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>path_env_1_2 <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_env_1_2_R-4-2-0&quot;</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="fu">rix</span>(</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="at">r_ver =</span> <span class="st">&quot;4.2.0&quot;</span>,</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_1_2,</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="at">shell_hook =</span> <span class="st">&quot;R&quot;</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a><span class="fu">list.files</span>(path_env_1_2)</span></code></pre></div>
<pre><code>#&gt; [1] &quot;default.nix&quot;</code></pre>
<p>Now, initiate a new R session as development environment using
<code>nix-shell</code>. Open a new terminal at the current working
directory of your R session. The provided expression
<code>default.nix</code>. defines R 4.1.3 in a “subfolder per subshell”
approach. <code>nix-shell</code> will use the expression by
<code>default.nix</code> and prefer it over any other <code>.nix</code>
files, except when you put a <code>shell.nix</code> file in that folder,
which takes precedence.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">nix-shell</span> <span class="at">--pure</span> ./_env_1_R-4-1-3</span></code></pre></div>
<p>After some time downloading caches and doing builds, you will enter
an R console session with R 4.1.3. You did not need to type in R first,
because we set up a R shell hook via <code>rix::rix()</code>. Next, we
define again the target function to test in R 4.2.0, too.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co"># current Nix-R session with R 4.1.3</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>df_as_vector <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(<span class="at">x =</span> x, <span class="at">mode =</span> <span class="st">&quot;list&quot;</span>)</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>}</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>(out_nix_1 <span class="ot">&lt;-</span> <span class="fu">df_as_vector</span>(<span class="at">x =</span> df))</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>out_nix_1_2 <span class="ot">&lt;-</span> <span class="fu">with_nix</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="at">expr =</span> <span class="cf">function</span>() <span class="fu">df_as_vector</span>(<span class="at">x =</span> df),</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="at">program =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_1_2,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="at">message_type =</span> <span class="st">&quot;simple&quot;</span> <span class="co"># you can do `&quot;verbose&quot;`, too</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>)</span></code></pre></div>
<p>You can now formally compare the outputs of the computation of the
same code in R 4.1.3 vs. R 4.2.0 environments controlled by Nix.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="fu">identical</span>(out_nix_1, out_nix_1_2)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co"># yields FALSE</span></span></code></pre></div>
</div>
</div>
<div id="case-study-2-breaking-changes-in-stringr-1.5.0" class="section level2">
<h2><strong>Case study 2: Breaking changes in {stringr}
1.5.0</strong></h2>
<p>We add one more layer to the reproducibility of the R ecosystem. User
libraries from CRAN or GitHub, one thing that makes R shine is the huge
collection of software packages available from the community.</p>
<p>There was a change introduce in {stringr} 1.5.0; in earlier versions,
this line of code:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>stringr<span class="sc">::</span><span class="fu">str_subset</span>(<span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;a&quot;</span>), <span class="st">&quot;&quot;</span>)</span></code></pre></div>
<p>would return the character <code>&quot;a&quot;</code>. However, this behaviour
is unexpected: it really should return an error. This was addressed in
versions after 1.5.0:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>out_system_stringr <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="at">expr =</span> {</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    stringr<span class="sc">::</span><span class="fu">str_subset</span>(<span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;a&quot;</span>), <span class="st">&quot;&quot;</span>)</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  },</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>  <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Since the code returns an error, we wrap it inside
<code>tryCatch()</code> and return <code>NULL</code> instead of an error
(if we wouldn’t do that, this vignette could not compile!).</p>
<p>Let’s build a subshell with the latest version of R, but an older
version of <code>{stringr}</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rix&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>path_env_stringr <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;.&quot;</span>, <span class="st">&quot;_env_stringr_1.4.1&quot;</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">rix</span>(</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  <span class="at">r_ver =</span> <span class="st">&quot;4.3.1&quot;</span>,</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  <span class="at">r_pkgs =</span> <span class="st">&quot;stringr@1.4.1&quot;</span>,</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_stringr</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>)</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="fu">list.files</span>(<span class="at">path =</span> path_env_stringr, <span class="at">all.files =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>#&gt; [1] &quot;.&quot;           &quot;..&quot;          &quot;.Rprofile&quot;   &quot;default.nix&quot;</code></pre>
<p>We can now run the code in the subshell</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>out_nix_stringr <span class="ot">&lt;-</span> <span class="fu">with_nix</span>(</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>  <span class="at">expr =</span> <span class="cf">function</span>() stringr<span class="sc">::</span><span class="fu">str_subset</span>(<span class="fu">c</span>(<span class="st">&quot;&quot;</span>, <span class="st">&quot;a&quot;</span>), <span class="st">&quot;&quot;</span>),</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>  <span class="at">program =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_stringr,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="at">message_type =</span> <span class="st">&quot;simple&quot;</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>)</span></code></pre></div>
<p>Here are the last few lines printed on screen:</p>
<pre><code>==&gt; `expr` succeeded!

### Finished code evaluation in `nix-shell` ###

* Evaluating `expr` in `nix-shell` returns:
[1] &quot;a&quot;</code></pre>
<p>Not only do we see the result of evaluating the code in the subshell,
we also have access to it: <code>out_nix_stringr</code> holds this
result.</p>
<p>We can now compare the two: the result of the code running in our
main session with the latest version of <code>{stringr}</code> and the
result of the code running in the subshell with the old version of
<code>{stringr}</code>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">identical</span>(out_system_stringr, out_nix_stringr)</span></code></pre></div>
<p>As expected, the result is <code>FALSE</code>.</p>
</div>
<div id="case-study-3-using-a-subshell-to-get-hard-to-install-dependencies" class="section level2">
<h2><strong>Case study 3: Using a subshell to get hard to install
dependencies</strong></h2>
<p>Nix subshells are quite useful in cases where you need to use a
package that might be difficult to install, such as
<code>{arrow}</code>, or other packages that must be compiled. Depending
on your operating system you need to compile <code>{arrow}</code> from
source, which can be a frustrating experience, especially if you only
need it to load data and bring it down to a manageable size (using
<code>select()</code> and <code>filter()</code> for instance). This use
cases illustrates how to achieve this.</p>
<p>Let’s start by building a subshell that is based on a distinct
revision of <code>nixpkgs</code>, for which we know that arrow compiles
on both linux and macOS (darwin).</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;rix&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>path_env_arrow <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">&quot;env_arrow&quot;</span>)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="fu">rix</span>(</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>  <span class="at">r_ver =</span> <span class="st">&quot;4.1.1&quot;</span>,</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  <span class="at">r_pkgs =</span> <span class="fu">c</span>(<span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;arrow&quot;</span>),</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span>,</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_arrow</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>)</span></code></pre></div>
<p>This specific revision of R contains <code>{arrow}</code> 13. Let’s
now suppose that you already have a script with some code to load and
transform some data using <code>{arrow}</code>. It may look something
like this:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">library</span>(arrow)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>arrow_cars <span class="ot">&lt;-</span> <span class="fu">arrow_table</span>(cars)</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>arrow_cars <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="fu">filter</span>(speed <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span></code></pre></div>
<p>To run this code in a subshell, we recommend wrapping it inside a
function:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>arrow_script <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  <span class="fu">library</span>(arrow)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="fu">library</span>(dplyr)</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  arrow_cars <span class="ot">&lt;-</span> <span class="fu">arrow_table</span>(cars)</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  arrow_cars <span class="sc">%&gt;%</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>    <span class="fu">filter</span>(speed <span class="sc">&gt;</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>    <span class="fu">as.data.frame</span>()</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>}</span></code></pre></div>
<p>Which we can then run in the subshell:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>out_nix_arrow <span class="ot">&lt;-</span> <span class="fu">with_nix</span>(</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  <span class="at">expr =</span> <span class="cf">function</span>() <span class="fu">arrow_script</span>(),</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  <span class="at">program =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="at">project_path =</span> path_env_arrow,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="at">message_type =</span> <span class="st">&quot;simple&quot;</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>)</span></code></pre></div>
<p>This will run the function in the subshell, and its output will be
saved in the <code>out_nix_arrow</code> variable, for further
manipulation in your main shell/session.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
